let md5 = require('md5');
let db = require('database');

db.run("CREATE TABLE IF NOT EXISTS User (login TEXT, password TEXT, nick TEXT, gold REAL, lastMining INTEGER)");

class User{
	static register(nick, login, password, callback){
		password = md5(password);
		//Check if user exists
		User.getByLogin(login, function(row){
			if (row === undefined){
				//User doesn't exist yet
				db.run("INSERT INTO User (nick, login, password, gold, lastMining) VALUES ($nick, $login, $password, $gold, strftime('%s','now'))", {
					$nick: nick,
					$login: login,
					$password: password,
					$gold: 0
				});
				callback(true);
			}else{
				callback(false);
				//User already exists !
				client.say(nick, "This login is already used");
			}
		});
	}

	static connect(nick, login, password){
		password = md5(password);
		db.serialize(function() {
			//Check if user exists
			User.getByLogin(login, function(row){
				if (row === undefined){
					client.say(nick, "No user was found for this login");
				}else{
					if (row.password === password){
						db.run("UPDATE User SET nick=$nick WHERE login=$login", {$nick: nick, $login: login});
						client.say(nick, "You are now logged in");
					}else{
						client.say(nick, "Incorrect password");
					}
				}
			});
		});
	}

	static getByLogin(login, callback){
		db.get("SELECT rowid AS id, login, nick, gold, lastMining FROM User WHERE login=?", login, function(err, row) {
			callback && callback(row);
		});
	}

	static getByNick(nick, callback){
		db.get("SELECT rowid AS id, login, nick, gold, lastMining FROM User WHERE nick=?", nick, function(err, row) {
			callback && callback(row);
		});
	}

	static updateNick(oldNick, newNick){
		db.run("UPDATE User SET nick=$newNick WHERE nick=$oldNick", {$newNick: newNick, $oldNick: oldNick});
	}

	static removeNick(nick){
		db.run("UPDATE User SET nick='none' WHERE nick=?", nick);
	}

	static addGold(nick, amount){
		db.run("UPDATE User SET gold=gold+$amount WHERE nick=$nick", {$amount: amount, $nick: nick});
	}

	static updateLastMining(nick, amount){
		db.run("UPDATE User SET lastMining=strftime('%s','now') WHERE nick=$nick", {$nick: nick});
	}
}