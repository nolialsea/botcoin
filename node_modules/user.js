let md5 = require('md5');
let db = require('database');

db.run("CREATE TABLE IF NOT EXISTS User (login TEXT, password TEXT, nick TEXT, gold REAL, lastMining INTEGER, level REAL)");

const User = {
	register: function(nick, login, password, callback){
		md5Password = md5(password);
		//Check if user exists
		User.getByLogin(login, function(row){
			if (row === undefined){
				//User doesn't exist yet
				db.run("INSERT INTO User (nick, login, password, gold, lastMining, level) VALUES ($nick, $login, $password, $gold, strftime('%s','now'), 1)", {
					$nick: nick,
					$login: login,
					$password: md5Password,
					$gold: 0
				});
				callback(true);
			}else{
				//User already exists !
				callback(false);
			}
		});
	},

	connect: function(nick, login, password, callback){
		md5Password = md5(password);
		db.serialize(function() {
			//Check if user exists
			User.getByLogin(login, function(user){
				if (!user){
					callback(-1);
				}else{
					//Already connected
					if (user.nick === nick){
						callback(1);
					}
					//Connection
					else if (user.password === md5Password){
						db.run("UPDATE User SET nick=$nick WHERE login=$login", {$nick: nick, $login: login});
						callback(2);
					}
					//Bad password
					else{
						callback(0);
					}
				}
			});
		});
	},

	getByLogin: function(login, callback){
		db.get("SELECT rowid AS id, login, password, nick, gold, lastMining, level FROM User WHERE login=?", login, function(err, row) {
			callback(row);
		});
	},

	getByNick: function(nick, callback){
		db.get("SELECT rowid AS id, login, password, nick, gold, lastMining, level FROM User WHERE nick=?", nick, function(err, row) {
			callback(row);
		});
	},

	updateNick: function(oldNick, newNick){
		db.run("UPDATE User SET nick=$newNick WHERE nick=$oldNick", {$newNick: newNick, $oldNick: oldNick});
	},

	removeNick: function(nick){
		db.run("UPDATE User SET nick=null WHERE nick=?", nick);
	},

	addGold: function(nick, amount){
		db.run("UPDATE User SET gold=gold+$amount WHERE nick=$nick", {$amount: amount, $nick: nick});
	},

	updateLastMining: function(nick){
		db.run("UPDATE User SET lastMining=strftime('%s','now') WHERE nick=$nick", {$nick: nick});
	},

	disconnectAll: function(){
		db.run("UPDATE User SET nick=null WHERE 1");
	}
}

module.exports = User;