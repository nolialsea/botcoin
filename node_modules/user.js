const md5 = require('md5');
const cfg = require('configuration');
const db = require('database');

db.run("CREATE TABLE IF NOT EXISTS User (login TEXT, password TEXT, nick TEXT, gold REAL, lastMining INTEGER, "+
										"level REAL, pickaxeId INTEGER)");

if (cfg.debug){
	User.disconnectAll();
	console.log('All clients have been disconnected');
}

const User = {
	insert: function(nick, login, password){
		db.run("INSERT INTO User (nick, login, password, gold, lastMining, level) VALUES ($nick, $login, $password, 0, strftime('%s','now'), 1)", {
			$nick: nick,
			$login: login,
			$password: md5(login+password)
		});
	},

	update: function(user){
		db.run("UPDATE User SET "+
			"nick=$nick, "+
			"gold=$gold, "+
			"level=$level, "+
			"pickaxeId=$pickaxeId, "+
			"lastMining=$lastMining "+
			" WHERE rowid=$id",
			{$nick: user.nick, $gold: user.gold, $level: user.level, $pickaxeId: user.pickaxeId, $lastMining: user.lastMining, $id: user.id});
	},

	register: function(nick, login, password, callback){
		let md5Password = md5(password);
		User.getByLogin(login, function(row){
			if (row === undefined){
				//User doesn't exist yet
				User.insert(nick, login, password);
				callback(true);
			}else{
				//User already exists !
				callback(false);
			}
		});
	},

	connect: function(nick, login, password, callback){
		db.serialize(function() {
			User.getByLogin(login, function(user){
				if (!user){
					callback(-1);
				}else{
					//Already connected
					if (user.nick === nick){
						callback(1);
					}
					//Connection
					else if (user.password === md5(login+password)){
						db.run("UPDATE User SET nick=$nick WHERE login=$login", {$nick: nick, $login: login});
						callback(2);
					}
					//Bad password
					else{
						callback(0);
					}
				}
			});
		});
	},

	mine: function(nick, duration){
		/*
			get player and his pickaxe
			check if there is no mining in process
			calculate mining
			create mining event
			
		*/
	},

	getByLogin: function(login, callback){
		db.get("SELECT rowid AS id, login, password, nick, gold, lastMining, level, pickaxeId FROM User WHERE login=?", login, function(err, row) {
			callback(row);
		});
	},

	getByNick: function(nick, callback){
		db.get("SELECT rowid AS id, login, password, nick, gold, lastMining, level, pickaxeId FROM User WHERE nick=?", nick, function(err, row) {
			callback(row);
		});
	},

	updateNick: function(oldNick, newNick){
		db.run("UPDATE User SET nick=$newNick WHERE nick=$oldNick", {$newNick: newNick, $oldNick: oldNick});
	},

	removeNick: function(nick){
		db.run("UPDATE User SET nick=null WHERE nick=?", nick);
	},

	addGold: function(nick, amount){
		db.run("UPDATE User SET gold=gold+$amount WHERE nick=$nick", {$amount: amount, $nick: nick});
	},

	addLevel: function(nick, amount){
		db.run("UPDATE User SET level=level+$amount WHERE nick=$nick", {$amount: amount, $nick: nick});
	},

	updateLastMining: function(nick){
		db.run("UPDATE User SET lastMining=strftime('%s','now') WHERE nick=$nick", {$nick: nick});
	},

	disconnectAll: function(){
		db.run("UPDATE User SET nick=null WHERE 1");
	}
}

module.exports = User;