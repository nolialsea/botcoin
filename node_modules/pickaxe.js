let db = require('database');

db.run("CREATE TABLE IF NOT EXISTS Pickaxe (name TEXT, power REAL, maxDurability REAL, durability REAL, upgrade INTEGER, repair INTEGER, userId INTEGER)");

module.exports = {
	create: function(name, power, durability, userId){
		db.serialize(function(){
			Pickaxe.delete(userId);
			db.run("INSERT INTO Pickaxe (name, power, maxDurability, durability, upgrade, repair, userId) VALUES ($name, $power, $durability, $durability, 0, 0, $userId)", {
				$name: name,
				$power: power,
				$durability: durability,
				$userId: userId
			});
		});
	},

	getByUserId: function(userId, callback){
		db.get("SELECT rowid AS id, name, power, durability, upgrade FROM Pickaxe WHERE userId=?", userId, function(err, row) {
			callback(row);
		});
	},

	delete: function(userId){	//Does not actually delete, on purpose for later
		db.run("UPDATE Pickaxe SET userId=0 WHERE userId=?", userId);
	},

	damage: function(userId, damage){
		db.run("UPDATE Pickaxe SET durability=durability-$damage WHERE userId=$userId", {$userId: userId, $damage: damage});
	},

	upgrade: function(userId, power, durability){
		db.run("UPDATE Pickaxe SET power=power+$power, maxDurability=maxDurability+$durability, upgrade=upgrade+1 WHERE userId=$userId", {$userId: userId, $power: power, $durability: durability});
	},

	repair: function(userId, amount){
		db.run("UPDATE Pickaxe SET durability=min(durability+$durability, maxDurability), repair=repair+1 WHERE userId=$userId", {$userId: userId, $durability: amount});
	}
}